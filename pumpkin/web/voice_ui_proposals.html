<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pumpkin Proposal Desk</title>
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect x='29' y='10' width='6' height='12' fill='%235b4b41'/><circle cx='32' cy='36' r='20' fill='%23e67c2e'/><circle cx='20' cy='36' r='14' fill='%23f08a3a' opacity='0.85'/><circle cx='44' cy='36' r='14' fill='%23f08a3a' opacity='0.85'/></svg>" />
    <style>
      :root {
        --bg: #f6efe8;
        --bg-accent: #f2d6b5;
        --ink: #2a1b12;
        --muted: #5b4b41;
        --pumpkin: #e67c2e;
        --pumpkin-dark: #b95519;
        --card: #fff8f2;
        --line: #e5d6c6;
        --ok: #2f9d57;
        --warn: #c27b1d;
        --bad: #c43b2b;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Iowan Old Style", "Palatino", "Bookman", "Georgia", serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 10% 10%, rgba(230, 124, 46, 0.15), transparent 40%),
          linear-gradient(160deg, var(--bg), var(--bg-accent));
        min-height: 100vh;
      }
      header {
        padding: 28px 24px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 26px;
        font-weight: 700;
      }
      .pumpkin-icon {
        width: 24px;
        height: 24px;
        flex: 0 0 auto;
      }
      .sub {
        color: var(--muted);
      }
      main {
        padding: 12px 24px 40px;
        display: grid;
        gap: 16px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 32px rgba(50, 33, 22, 0.08);
      }
      .card h3 {
        margin: 0 0 8px;
        font-size: 16px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }
      .proposal {
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fffdf9;
        display: grid;
        gap: 8px;
      }
      .trail {
        margin-top: 8px;
        font-size: 12px;
        background: #fffdf9;
        padding: 10px;
        border-radius: 10px;
        border: 1px dashed #e7c7a9;
        display: grid;
        gap: 8px;
      }
      .trail.hidden {
        display: none;
      }
      .trail-toggle {
        font-size: 12px;
        color: var(--pumpkin-dark);
        text-decoration: underline;
        cursor: pointer;
      }
      .trail pre {
        margin: 6px 0 0;
        font-size: 12px;
        white-space: pre-wrap;
        background: #fff7ef;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #f3c8a5;
      }
      .proposal-title {
        font-weight: 700;
        font-size: 16px;
      }
      .meta {
        font-size: 13px;
        color: var(--muted);
        display: grid;
        gap: 4px;
      }
      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      button {
        border: 1px solid var(--line);
        background: var(--card);
        color: var(--ink);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
      }
      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(230, 124, 46, 0.12);
        color: var(--pumpkin-dark);
        font-size: 12px;
        font-weight: 600;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      a {
        color: var(--pumpkin-dark);
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title">
        <svg class="pumpkin-icon" viewBox="0 0 64 64" aria-hidden="true">
          <rect x="29" y="10" width="6" height="12" fill="var(--muted)" />
          <circle cx="32" cy="36" r="20" fill="var(--pumpkin)" />
          <circle cx="20" cy="36" r="14" fill="#f08a3a" opacity="0.85" />
          <circle cx="44" cy="36" r="14" fill="#f08a3a" opacity="0.85" />
        </svg>
        Proposal Desk
      </div>
      <div class="sub">
        Review, approve, or reject pending proposals.
        <a href="/ui">Back to dashboard →</a>
      </div>
    </header>
    <main>
      <section class="card">
        <h3>Pending Proposals</h3>
        <div class="row" style="margin-bottom: 8px;">
          <span class="pill" id="count">0 pending</span>
          <button id="refresh">Refresh</button>
        </div>
        <div id="list"></div>
      </section>
      <section class="card">
        <h3>Restricted Requests</h3>
        <div class="row" style="margin-bottom: 8px;">
          <span class="pill" id="restricted-count">0 pending</span>
          <button id="restricted-refresh">Refresh</button>
        </div>
        <div id="restricted-list"></div>
      </section>
    </main>
    <script>
      const listNode = document.getElementById("list");
      const countNode = document.getElementById("count");
      const restrictedListNode = document.getElementById("restricted-list");
      const restrictedCountNode = document.getElementById("restricted-count");

      const render = (items) => {
        listNode.innerHTML = "";
        if (!items.length) {
          const empty = document.createElement("div");
          empty.textContent = "No pending proposals.";
          listNode.appendChild(empty);
          return;
        }
        items.forEach((proposal) => {
          const card = document.createElement("div");
          card.className = "proposal";

          const title = document.createElement("div");
          title.className = "proposal-title";
          title.textContent = proposal.summary || "Untitled proposal";

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.innerHTML = `
            <div>Kind: ${proposal.kind || "unknown"} • Status: ${proposal.status || "pending"}</div>
            <div>Risk: ${proposal.risk ?? "n/a"} • Expected: ${proposal.expected_outcome || "n/a"}</div>
            <div>Needs capability: ${proposal.needs_new_capability ? "yes" : "no"}</div>
            <div>Capability request: ${proposal.capability_request || "none"}</div>
            <div>Created: ${proposal.ts_created || "unknown"}</div>
          `;

          const details = document.createElement("pre");
          details.style.whiteSpace = "pre-wrap";
          details.style.fontSize = "12px";
          details.style.background = "#fff7ef";
          details.style.padding = "8px";
          details.style.borderRadius = "8px";
          details.textContent = proposal.details ? JSON.stringify(proposal.details, null, 2) : "No details payload.";

          const trail = document.createElement("div");
          trail.className = "trail";
          if (Array.isArray(proposal.trail) && proposal.trail.length) {
            trail.classList.add("hidden");
            const rows = proposal.trail.map((event) => {
              const payload = event.payload ? JSON.stringify(event.payload, null, 2) : "";
              return `
                <div class="row">
                  <span class="pill">${event.source || "event"}</span>
                  <span>${event.type || "unknown"} • ${event.ts || "n/a"} • id ${event.id || "n/a"}</span>
                  <pre>${payload || "No payload."}</pre>
                </div>
              `;
            }).join("");
            trail.innerHTML = `<div class="sub">Trail</div>${rows}`;
          } else {
            trail.textContent = "No linked events yet.";
          }

          const trailToggle = document.createElement("div");
          if (Array.isArray(proposal.trail) && proposal.trail.length) {
            trailToggle.className = "trail-toggle";
            trailToggle.textContent = "View trail";
            trailToggle.addEventListener("click", () => {
              const hidden = trail.classList.toggle("hidden");
              trailToggle.textContent = hidden ? "View trail" : "Hide trail";
            });
          }

          const actions = document.createElement("div");
          actions.className = "actions";

          const approve = document.createElement("button");
          approve.textContent = "Approve";
          approve.addEventListener("click", () => sendDecision(proposal.id, "approved"));

          const reject = document.createElement("button");
          reject.textContent = "Reject";
          reject.addEventListener("click", () => sendDecision(proposal.id, "rejected"));

          actions.appendChild(approve);
          actions.appendChild(reject);

          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(details);
          if (trailToggle.textContent) {
            card.appendChild(trailToggle);
          }
          card.appendChild(trail);
          card.appendChild(actions);
          listNode.appendChild(card);
        });
      };

      const renderRestricted = (items) => {
        restrictedListNode.innerHTML = "";
        if (!items.length) {
          const empty = document.createElement("div");
          empty.textContent = "No restricted requests.";
          restrictedListNode.appendChild(empty);
          return;
        }
        items.forEach((request) => {
          const card = document.createElement("div");
          card.className = "proposal";

          const title = document.createElement("div");
          title.className = "proposal-title";
          title.textContent = request.summary || "Restricted request";

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.innerHTML = `
            <div>Status: ${request.status || "pending"}</div>
            <div>Risk: ${request.risk ?? "n/a"} • Expected: ${request.expected_outcome || "n/a"}</div>
            <div>Created: ${request.ts_created || "unknown"}</div>
          `;

          const details = document.createElement("pre");
          details.style.whiteSpace = "pre-wrap";
          details.style.fontSize = "12px";
          details.style.background = "#fff7ef";
          details.style.padding = "8px";
          details.style.borderRadius = "8px";
          details.textContent = request.details ? JSON.stringify(request.details, null, 2) : "No details payload.";

          const actions = document.createElement("div");
          actions.className = "actions";

          const approve = document.createElement("button");
          approve.textContent = "Approve";
          approve.addEventListener("click", () => sendRestrictedDecision(request.id, "approve"));

          const reject = document.createElement("button");
          reject.textContent = "Reject";
          reject.addEventListener("click", () => sendRestrictedDecision(request.id, "deny"));

          actions.appendChild(approve);
          actions.appendChild(reject);

          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(details);
          card.appendChild(actions);
          restrictedListNode.appendChild(card);
        });
      };

      const load = async () => {
        try {
          const res = await fetch("/proposals?status=pending&limit=25&include_events=1");
          const data = await res.json();
          const items = Array.isArray(data.proposals) ? data.proposals : [];
          countNode.textContent = `${items.length} pending`;
          render(items);
        } catch (err) {
          listNode.innerHTML = "Failed to load proposals.";
        }
      };

      const loadRestricted = async () => {
        try {
          const res = await fetch("/restricted_requests?status=pending");
          const data = await res.json();
          const items = Array.isArray(data.restricted_requests) ? data.restricted_requests : [];
          restrictedCountNode.textContent = `${items.length} pending`;
          renderRestricted(items);
        } catch (err) {
          restrictedListNode.innerHTML = "Failed to load restricted requests.";
        }
      };

      const sendDecision = async (id, decision) => {
        const reason = window.prompt("Reason (optional):") || "";
        const payload = { id, actor: "web", reason: reason.trim() || null };
        const url = decision === "approved" ? "/proposals/approve" : "/proposals/reject";
        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            throw new Error("Request failed");
          }
          await load();
        } catch (err) {
          window.alert("Failed to update proposal.");
        }
      };

      const sendRestrictedDecision = async (id, decision) => {
        const payload = { id };
        const url = decision === "approve" ? "/restricted/approve" : "/restricted/deny";
        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            throw new Error("Request failed");
          }
          await loadRestricted();
        } catch (err) {
          window.alert("Failed to update restricted request.");
        }
      };

      document.getElementById("refresh").addEventListener("click", load);
      document.getElementById("restricted-refresh").addEventListener("click", loadRestricted);
      load();
      loadRestricted();
    </script>
  </body>
</html>
