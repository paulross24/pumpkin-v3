<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pumpkin Voice UI</title>
    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect x='29' y='10' width='6' height='12' fill='%235b4b41'/><circle cx='32' cy='36' r='20' fill='%23e67c2e'/><circle cx='20' cy='36' r='14' fill='%23f08a3a' opacity='0.85'/><circle cx='44' cy='36' r='14' fill='%23f08a3a' opacity='0.85'/></svg>" />
    <style>
      :root {
        --bg: #f6efe8;
        --bg-accent: #f2d6b5;
        --ink: #2a1b12;
        --muted: #5b4b41;
        --pumpkin: #e67c2e;
        --pumpkin-dark: #b95519;
        --card: #fff8f2;
        --line: #e5d6c6;
        --ok: #2f9d57;
        --warn: #c27b1d;
        --bad: #c43b2b;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Iowan Old Style", "Palatino", "Bookman", "Georgia", serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 15% 10%, rgba(230, 124, 46, 0.15), transparent 40%),
          radial-gradient(circle at 80% 20%, rgba(178, 85, 25, 0.1), transparent 45%),
          linear-gradient(160deg, var(--bg), var(--bg-accent));
        min-height: 100vh;
      }
      header {
        padding: 28px 24px 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 28px;
        font-weight: 700;
      }
      .pumpkin-icon {
        width: 26px;
        height: 26px;
        flex: 0 0 auto;
      }
      .sub {
        color: var(--muted);
      }
      .menu {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .menu a {
        text-decoration: none;
        color: var(--pumpkin-dark);
        background: rgba(230, 124, 46, 0.12);
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        border: 1px solid var(--line);
      }
      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      button {
        border: 1px solid var(--line);
        background: var(--card);
        color: var(--ink);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
      }
      main {
        padding: 8px 24px 40px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 32px rgba(50, 33, 22, 0.08);
        animation: fadeUp 0.4s ease both;
        display: grid;
        gap: 8px;
      }
      .card.is-link {
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .card.is-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 36px rgba(50, 33, 22, 0.14);
      }
      .card-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .card-cta {
        font-size: 12px;
        font-weight: 600;
        color: var(--pumpkin-dark);
      }
      .card h3 {
        margin: 0;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }
      .stat {
        font-size: 22px;
        font-weight: 700;
      }
      .list {
        margin: 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 6px;
        font-size: 13px;
        color: var(--muted);
      }
      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(230, 124, 46, 0.12);
        color: var(--pumpkin-dark);
        font-size: 12px;
        font-weight: 600;
      }
      .link {
        color: var(--pumpkin-dark);
        text-decoration: none;
        font-weight: 600;
      }
      .grid-span {
        grid-column: span 2;
      }
      @media (max-width: 720px) {
        .grid-span {
          grid-column: span 1;
        }
      }
      .status-ok {
        color: var(--ok);
      }
      .status-warn {
        color: var(--warn);
      }
      .status-bad {
        color: var(--bad);
      }
      .pulse-card {
        display: grid;
        grid-template-columns: 180px 1fr;
        align-items: center;
        gap: 16px;
      }
      @media (max-width: 720px) {
        .pulse-card {
          grid-template-columns: 1fr;
          text-align: center;
        }
      }
      .pulse-shell {
        width: 170px;
        height: 170px;
        margin: 0 auto;
        position: relative;
      }
      .pumpkin-svg {
        width: 170px;
        height: 170px;
      }
      .thought-bobble {
        position: absolute;
        top: -14px;
        right: -6px;
        width: 170px;
        height: 92px;
        background: rgba(255, 250, 244, 0.96);
        border: 2px solid var(--line);
        border-radius: 28px;
        box-shadow: 0 12px 24px rgba(50, 33, 22, 0.15);
        display: flex;
        align-items: center;
        padding: 10px 12px;
      }
      .thought-bobble::before {
        content: "";
        position: absolute;
        bottom: -12px;
        left: 26px;
        width: 18px;
        height: 18px;
        background: rgba(255, 250, 244, 0.96);
        border: 2px solid var(--line);
        border-radius: 999px;
      }
      .thought-bobble::after {
        content: "";
        position: absolute;
        bottom: -24px;
        left: 14px;
        width: 10px;
        height: 10px;
        background: rgba(255, 250, 244, 0.96);
        border: 2px solid var(--line);
        border-radius: 999px;
      }
      .reel {
        overflow: hidden;
        width: 100%;
        height: 100%;
        font-size: 11px;
        color: var(--muted);
        display: flex;
        align-items: center;
      }
      .reel-track {
        display: flex;
        gap: 20px;
        white-space: nowrap;
        animation: reelScroll 18s linear infinite;
      }
      .reel-track span {
        display: inline-block;
        padding-right: 20px;
      }
      .pulse-shell[data-level="1"] .reel-track {
        animation-duration: 14s;
      }
      .pulse-shell[data-level="2"] .reel-track {
        animation-duration: 10s;
      }
      .pulse-shell[data-level="3"] .reel-track {
        animation-duration: 7s;
        color: var(--bad);
      }
      @keyframes reelScroll {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-50%);
        }
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title-row">
        <div class="title">
          <svg class="pumpkin-icon" viewBox="0 0 64 64" aria-hidden="true">
            <rect x="29" y="10" width="6" height="12" fill="var(--muted)" />
            <circle cx="32" cy="36" r="20" fill="var(--pumpkin)" />
            <circle cx="20" cy="36" r="14" fill="#f08a3a" opacity="0.85" />
            <circle cx="44" cy="36" r="14" fill="#f08a3a" opacity="0.85" />
          </svg>
          Pumpkin Command Center
        </div>
        <div class="actions">
          <button id="refresh">Refresh now</button>
          <span class="pill" id="heartbeat">Waiting for heartbeat</span>
        </div>
      </div>
      <div class="sub" id="subtitle">Loading status...</div>
      <nav class="menu">
        <a href="/ui">Overview</a>
        <a href="/ui/health">Health</a>
        <a href="/ui/identity">Identity</a>
        <a href="/ui/thoughts">Thoughts</a>
        <a href="/ui/insights">Insights</a>
        <a href="/ui/memory">Memory</a>
        <a href="/ui/homeassistant">Home Assistant</a>
        <a href="/ui/autonomy">Autonomy</a>
        <a href="/ui/scoreboard">Scoreboard</a>
        <a href="/ui/proposals">Proposals</a>
        <a href="/ui/audit">Audit</a>
        <a href="/ui/network">Network</a>
        <a href="/ui/vision">Vision</a>
        <a href="/ui/dogwatch">Dog Watch</a>
        <a href="/ui/car">Car</a>
        <a href="/ui/alerts">Alerts</a>
        <a href="/ui/inventory">Inventory</a>
      </nav>
    </header>
    <main>
      <section class="card grid-span pulse-card is-link" data-link="/ui/thoughts">
        <div class="pulse-shell" id="thought-pulse" data-level="0">
          <svg class="pumpkin-svg" viewBox="0 0 200 200" aria-hidden="true">
            <rect x="90" y="24" width="20" height="36" rx="6" fill="#5b4b41" />
            <ellipse cx="100" cy="120" rx="78" ry="58" fill="var(--pumpkin)" />
            <ellipse cx="64" cy="120" rx="44" ry="54" fill="#f08a3a" opacity="0.85" />
            <ellipse cx="136" cy="120" rx="44" ry="54" fill="#f08a3a" opacity="0.85" />
            <path d="M100 64 Q92 110 100 176" fill="none" stroke="#c4652f" stroke-width="4" opacity="0.7" />
            <path d="M78 68 Q70 118 78 172" fill="none" stroke="#d17833" stroke-width="3" opacity="0.7" />
            <path d="M122 68 Q130 118 122 172" fill="none" stroke="#d17833" stroke-width="3" opacity="0.7" />
          </svg>
          <div class="thought-bobble">
            <div class="reel">
              <div class="reel-track" id="thought-reel">
                <span>Loading thought reel…</span>
                <span>Loading thought reel…</span>
              </div>
            </div>
          </div>
        </div>
        <div>
          <div class="card-head">
            <h3>Thought Pulse</h3>
            <span class="card-cta">Open →</span>
          </div>
          <div class="stat" id="thought-status">Listening...</div>
          <ul class="list" id="thought-meta"></ul>
        </div>
      </section>
      <section class="card is-link" data-link="/ui/health">
        <div class="card-head">
          <h3>System Health</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="health-status">...</div>
        <ul class="list" id="health-details"></ul>
      </section>
      <section class="card is-link" data-link="/ui/identity">
        <div class="card-head">
          <h3>Identity</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="identity-name">Unknown</div>
        <ul class="list" id="identity-meta"></ul>
      </section>
      <section class="card is-link" data-link="/ui/proposals">
        <div class="card-head">
          <h3>Proposals</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="proposal-count">0</div>
        <div class="sub">
          <a class="link" href="/ui/proposals">Open proposal desk →</a>
        </div>
        <ul class="list" id="proposal-list"></ul>
      </section>
      <section class="card is-link" data-link="/ui/autonomy">
        <div class="card-head">
          <h3>Autonomy</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="autonomy-total">0</div>
        <div class="sub">
          <a class="link" href="/ui/autonomy">Open autonomy desk →</a>
        </div>
        <ul class="list" id="autonomy-list"></ul>
      </section>
      <section class="card is-link" data-link="/ui/scoreboard">
        <div class="card-head">
          <h3>Scoreboard</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="scoreboard-title">Pumpkin vs Alexa</div>
        <div class="sub">
          <a class="link" href="/ui/scoreboard">Open scoreboard →</a>
        </div>
        <ul class="list" id="scoreboard-list"></ul>
      </section>
      <section class="card is-link" data-link="/ui/alerts">
        <div class="card-head">
          <h3>Alerts</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="alerts-count">0</div>
        <div class="sub">
          <a class="link" href="/ui/alerts">Open alerts →</a>
        </div>
        <ul class="list" id="alerts-list"></ul>
      </section>
      <section class="card is-link" data-link="/ui/network">
        <div class="card-head">
          <h3>Network</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="network-count">0 devices</div>
        <div class="sub">
          <a class="link" href="/ui/network">Open network desk →</a>
        </div>
        <ul class="list" id="network-list"></ul>
      </section>
      <section class="card is-link" data-link="/ui/vision">
        <div class="card-head">
          <h3>Cameras</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="camera-count">0</div>
        <div class="sub">
          <a class="link" href="/ui/vision">Review unknown faces →</a>
        </div>
        <ul class="list" id="camera-list"></ul>
      </section>
      <section class="card is-link" data-link="/ui/insights">
        <div class="card-head">
          <h3>Insights</h3>
          <span class="card-cta">Open →</span>
        </div>
        <div class="stat" id="insight-count">0</div>
        <div class="sub" id="briefing-text">No briefing yet.</div>
        <ul class="list" id="insight-list"></ul>
      </section>
    </main>
    <script>
      const byId = (id) => document.getElementById(id);
      const setText = (node, text) => {
        if (node) node.textContent = text;
      };
      const setList = (node, items) => {
        if (!node) return;
        node.innerHTML = "";
        if (!items.length) {
          const li = document.createElement("li");
          li.textContent = "None";
          node.appendChild(li);
          return;
        }
        items.forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          node.appendChild(li);
        });
      };

      const subtitle = byId("subtitle");
      const heartbeat = byId("heartbeat");
      const healthStatus = byId("health-status");
      const healthDetails = byId("health-details");
      const proposalCount = byId("proposal-count");
      const proposalList = byId("proposal-list");
      const autonomyTotal = byId("autonomy-total");
      const autonomyList = byId("autonomy-list");
      const scoreboardList = byId("scoreboard-list");
      const alertsCount = byId("alerts-count");
      const alertsList = byId("alerts-list");
      const networkCount = byId("network-count");
      const networkList = byId("network-list");
      const cameraCount = byId("camera-count");
      const cameraList = byId("camera-list");
      const identityName = byId("identity-name");
      const identityMeta = byId("identity-meta");
      const insightCount = byId("insight-count");
      const insightList = byId("insight-list");
      const briefingText = byId("briefing-text");
      const thoughtPulse = byId("thought-pulse");
      const thoughtStatus = byId("thought-status");
      const thoughtMeta = byId("thought-meta");
      const thoughtReel = byId("thought-reel");

      const linkCards = () => {
        const cards = document.querySelectorAll(".card.is-link");
        cards.forEach((card) => {
          card.addEventListener("click", (event) => {
            const target = event.target;
            if (target && (target.tagName === "A" || target.tagName === "BUTTON")) return;
            const link = card.dataset.link;
            if (link) window.location.href = link;
          });
        });
      };

      const formatProposal = (proposal) => `${proposal.summary} (${proposal.status})`;
      const formatDevice = (device) => {
        const ip = device.ip || "unknown";
        const ports = Array.isArray(device.open_ports) && device.open_ports.length
          ? device.open_ports.join(",")
          : "no ports";
        const hints = Array.isArray(device.hints) && device.hints.length
          ? ` | ${device.hints.join(", ")}`
          : "";
        return `${ip} - ${ports}${hints}`;
      };
      const formatInsight = (item) => {
        const title = item.title || "Insight";
        const detail = item.detail ? ` - ${item.detail}` : "";
        return `${title}${detail}`;
      };
      const formatCamera = (camera) => {
        const label = camera.label || camera.id || camera.ip || "camera";
        const source = camera.source || "unknown";
        return `${label} (${source})`;
      };

      const pulseLevel = (summary, alertsCountValue) => {
        const issues = summary.issues || [];
        const proposals = summary.proposals || [];
        const insights = summary.insights || [];
        const heartbeatEvent = summary.heartbeat;
        let level = 0;
        if (proposals.length || insights.length > 3) level = 1;
        if (issues.length || alertsCountValue > 0) level = 2;
        let heartbeatAge = null;
        if (heartbeatEvent && heartbeatEvent.ts) {
          const parsed = Date.parse(heartbeatEvent.ts);
          if (!Number.isNaN(parsed)) {
            heartbeatAge = Math.max(0, (Date.now() - parsed) / 1000);
            if (heartbeatAge > 120) level = 3;
          }
        }
        const status = level === 3 ? "Stalled" : level === 2 ? "Alert" : level === 1 ? "Active" : "Idle";
        return { level, status, heartbeatAge };
      };

      const loadAlerts = async () => {
        try {
          const res = await fetch("/notifications?limit=5");
          const data = await res.json();
          const items = Array.isArray(data.notifications) ? data.notifications : [];
          setText(alertsCount, data.count ?? items.length);
          setList(
            alertsList,
            items.map((alert) => `${alert.ts || "unknown"} - ${alert.message || "alert"}`)
          );
          return { count: data.count ?? items.length, items };
        } catch (err) {
          setText(alertsCount, "0");
          setList(alertsList, ["Failed to load alerts"]);
          return { count: 0, items: [] };
        }
      };

      const buildThoughtReel = (thoughts) => {
        const reelItems = thoughts.length
          ? thoughts.map((item) => item.message || "activity")
          : ["idle: monitoring voice, network, cameras"];
        const line = reelItems.join(" • ");
        if (thoughtReel) {
          thoughtReel.innerHTML = "";
          const spanA = document.createElement("span");
          const spanB = document.createElement("span");
          spanA.textContent = line;
          spanB.textContent = line;
          thoughtReel.appendChild(spanA);
          thoughtReel.appendChild(spanB);
        }
      };

      const loadThoughts = async () => {
        try {
          const res = await fetch("/thoughts?limit=10");
          const data = await res.json();
          return Array.isArray(data.thoughts) ? data.thoughts : [];
        } catch (err) {
          return [];
        }
      };

      const load = async () => {
        try {
          linkCards();
          const [healthRes, summaryRes, configRes] = await Promise.all([
            fetch("/health"),
            fetch("/summary"),
            fetch("/config"),
          ]);
          const health = await healthRes.json();
          const summary = await summaryRes.json();
          const config = await configRes.json();

          setText(
            subtitle,
            `${config.service?.name || "Pumpkin"} ${config.service?.version || ""} at ${config.http?.host || "host"}:${config.http?.port || "port"}`
          );
          setText(
            heartbeat,
            summary.heartbeat ? `Heartbeat ${summary.heartbeat.ts}` : "No heartbeat yet"
          );

          setText(healthStatus, health.status || "unknown");
          if (healthStatus) {
            healthStatus.className = "stat " + (health.status === "ok" ? "status-ok" : "status-warn");
          }
          const metrics = health.metrics || {};
          setList(healthDetails, [
            `load: ${metrics.loadavg?.["1m"] ?? "-"}`,
            `disk: ${metrics.disk?.used_percent ?? "-"}`,
            `mem: ${metrics.meminfo_kb?.MemAvailable ?? "-"} KB`,
          ]);

          const identity = summary.identity || {};
          const profile = identity.profile || {};
          const deviceId = profile.last_device || identity.device || "n/a";
          setText(identityName, profile.name || "Unknown speaker (unlinked)");
          setList(identityMeta, [
            `last seen: ${profile.last_seen_ts || "n/a"}`,
            `turns: ${profile.turns_count ?? "n/a"}`,
            `device: ${deviceId}`,
          ]);

          setText(proposalCount, summary.proposal_count || 0);
          const proposals = (summary.proposals || []).slice(0, 3).map(formatProposal);
          setList(proposalList, proposals);

          const autonomy = summary.autonomy || {};
          setText(autonomyTotal, autonomy.total_executed ?? 0);
          const autonomyItems = [
            `last run: ${autonomy.last_executed_ts || "n/a"}`,
            `last executed: ${autonomy.last_executed_count ?? 0}`,
          ];
          const recentActions = autonomy.recent_actions || [];
          if (recentActions.length) {
            autonomyItems.push(`recent: ${recentActions.length}`);
          }
          setList(autonomyList, autonomyItems);

          const inventorySummary = summary.inventory || {};
          const moduleCount = (inventorySummary.enabled_modules || []).length;
          const areaCount = inventorySummary.ha_area_count ?? 0;
          const deviceCount = inventorySummary.network_device_count ?? 0;
          setList(scoreboardList, [
            `modules: ${moduleCount}`,
            `areas: ${areaCount}`,
            `network devices: ${deviceCount}`,
          ]);

          const discovery = summary.network_discovery || {};
          setText(networkCount, `${discovery.device_count || 0} devices`);
          setList(networkList, (discovery.devices || []).slice(0, 4).map(formatDevice));

          const cameras = Array.isArray(summary.camera_registry) ? summary.camera_registry : [];
          setText(cameraCount, cameras.length || 0);
          setList(cameraList, cameras.slice(0, 4).map(formatCamera));

          const insights = summary.insights || [];
          setText(insightCount, insights.length);
          setList(insightList, insights.slice(0, 4).map(formatInsight));
          if (summary.briefing && summary.briefing.summary) {
            setText(briefingText, summary.briefing.summary);
          } else {
            setText(briefingText, "No briefing yet.");
          }

          const alertData = await loadAlerts();
          const thoughts = await loadThoughts();
          buildThoughtReel(thoughts);
          const pulse = pulseLevel(summary, alertData.count);
          if (thoughtPulse) {
            thoughtPulse.dataset.level = String(pulse.level);
          }
          setText(thoughtStatus, pulse.status);
          const pulseMeta = [
            `issues: ${(summary.issues || []).length}`,
            `alerts: ${alertData.count}`,
            `proposals: ${summary.proposal_count || 0}`,
            `insights: ${insights.length}`,
          ];
          if (pulse.heartbeatAge != null) {
            pulseMeta.push(`heartbeat age: ${pulse.heartbeatAge.toFixed(0)}s`);
          }
          setList(thoughtMeta, pulseMeta);
        } catch (err) {
          setText(subtitle, "Failed to load status.");
        }
      };

      const refreshBtn = byId("refresh");
      if (refreshBtn) {
        refreshBtn.addEventListener("click", load);
      }
      load();
      setInterval(load, 15000);
    </script>
  </body>
</html>
